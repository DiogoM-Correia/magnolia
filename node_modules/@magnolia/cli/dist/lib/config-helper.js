var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import fs from 'fs-extra';
import path from 'path';
import beautifyModule from 'js-beautify';
import { installCLI } from './helper.js';
import ora from 'ora';
import { initI18n } from '@magnolia/cli-helper/i18n';
import { fileURLToPath } from 'url';
import { BEAUTIFY_OPTIONS } from '@magnolia/cli-helper/general-utils';
const { js_beautify } = beautifyModule;
import { getMgnlConfigPath } from '@magnolia/cli-helper/config';
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
let logger;
const i18nInstance = initI18n('config-helper', 'helper', path.join(__dirname, 'locales'));
export const setLogger = (winstonLogger) => {
    logger = winstonLogger;
};
const getPackageConfigPath = () => path.join(process.cwd(), 'node_modules/@magnolia/cli/mgnl.config.js');
export const handleMGNLConfigFile = (useMjsExtension) => __awaiter(void 0, void 0, void 0, function* () {
    let isMgnlCliInstalled = true;
    if (!fs.existsSync(getPackageConfigPath())) {
        isMgnlCliInstalled = yield installCLI();
    }
    if (isMgnlCliInstalled) {
        const configPath = useMjsExtension
            ? path.join(process.cwd(), 'mgnl.config.mjs')
            : getMgnlConfigPath();
        if (fs.existsSync(configPath)) {
            if (!useMjsExtension) {
                handleExistingConfigFile();
            }
        }
        else {
            createMgnlConfigFile(useMjsExtension);
        }
    }
    else {
        logger === null || logger === void 0 ? void 0 : logger.error(i18nInstance.t('error-mgnl-cli-not-installed'));
    }
});
const handleExistingConfigFile = () => {
    const localConfigContent = fs.readFileSync(getMgnlConfigPath(), 'utf8');
    const packageConfigContent = fs.readFileSync(getPackageConfigPath(), 'utf8');
    const localLoggerConfig = extractLoggerConfig(localConfigContent);
    const globalLoggerConfig = extractLoggerConfig(packageConfigContent);
    if (!localLoggerConfig && globalLoggerConfig && globalLoggerConfig[1]) {
        const loggerContent = getLoggerContent(globalLoggerConfig[1]);
        const newLocalConfigContent = localConfigContent.replace(/(export\s+default\s+\{)/, `$1${loggerContent}`);
        writeConfigContent(newLocalConfigContent, false, false);
    }
};
function createMgnlConfigFile(useMjsExtension) {
    const packageConfigContent = fs.readFileSync(getPackageConfigPath(), 'utf8');
    const loggerConfig = extractLoggerConfig(packageConfigContent);
    const mgnlConfigPrefix = `
    export default {`;
    const logger = loggerConfig && loggerConfig[1]
        ? getLoggerContent(loggerConfig[1])
        : '';
    const mgnlConfigSufix = `
    // Here you can add plugins you want to use with MGNL CLI
    plugins: []
    };`;
    const mgnlConfigContent = mgnlConfigPrefix + logger + mgnlConfigSufix;
    writeConfigContent(mgnlConfigContent, true, useMjsExtension);
}
function getLoggerContent(logger) {
    return `
    // Logger configuration
    // see: https://github.com/winstonjs/winston#logging for logging levels explanation
    ${logger},`;
}
const extractLoggerConfig = (content) => {
    const loggerRegex = /(logger\s*:\s*{[^}]*})/;
    return loggerRegex.exec(content);
};
const writeConfigContent = (content, creating, useMjsExtension) => {
    const configPath = useMjsExtension
        ? path.join(process.cwd(), 'mgnl.config.mjs')
        : getMgnlConfigPath();
    const spinner = ora().start(i18nInstance.t(creating
        ? 'ora-start-creating-config'
        : 'ora-start-updating-config'));
    try {
        const finalContent = js_beautify(content.trim(), BEAUTIFY_OPTIONS);
        fs.writeFileSync(configPath, finalContent, 'utf-8');
        spinner.succeed(i18nInstance.t(creating
            ? 'ora-succeed-config-created'
            : 'ora-succeed-config-updated'));
    }
    catch (e) {
        spinner.fail(i18nInstance.t(creating
            ? 'ora-fail-creating-config'
            : 'ora-fail-updating-config', { errorMsg: e.message }));
    }
};
