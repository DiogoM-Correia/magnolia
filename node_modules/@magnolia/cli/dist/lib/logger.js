import fs from 'fs-extra';
import moment from 'moment-timezone';
import { createLogger, format, transports } from 'winston';
const { combine, timestamp, label, printf, colorize } = format;
export const winstonLogger = (config, pluginName, pluginVersion) => {
    const { filename, fileLevel, consoleLevel, fileSilent, consoleSilent } = config.logger || {};
    const systemTimezone = moment.tz.guess();
    const customFormat = combine(label({ label: pluginName }), timestamp({
        format: moment()
            .tz(systemTimezone)
            .format('YYYY-MM-DDTHH:mm:ss.SSSZ'),
    }), printf(({ level, message, label, timestamp }) => {
        return `[${label}@${pluginVersion}] ${timestamp} ${level}: ${message}`;
    }));
    const consoleCustomFormat = combine(colorize({ level: true }), printf((info) => `${info.level}: ${info.message}`));
    const logger = createLogger({
        level: fileLevel || 'warn',
        format: customFormat,
        transports: [
            new transports.Console({
                level: consoleLevel || 'debug',
                format: consoleCustomFormat,
                silent: consoleSilent,
            }),
        ],
    });
    if (filename && !fileSilent) {
        if (fs.existsSync('.gitignore') && !fs.existsSync(filename)) {
            fs.appendFileSync('.gitignore', '\n' + filename, 'utf8');
        }
        logger.add(new transports.File({ filename, silent: fileSilent }));
    }
    return logger;
};
