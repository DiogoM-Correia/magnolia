# mgnl-v5-tabcompletion-version 1.0.0
_mgnl_tab_completion() {
  local cur prev script_output commands
  COMPREPLY=()
  cur="${COMP_WORDS[COMP_CWORD]}"
  prev="${COMP_WORDS[COMP_CWORD-1]}"

  local LOCAL_OFFSET=2
  local GLOBAL_OFFSET=0
  local LOCAL_FLAG_START=5
  local GLOBAL_FLAG_START=3

  # Determine mode and set offset and flag_start_index.
  local mode=""
  local platform=""
  local offset=0
  local flag_start_index=0
  if [[ "${COMP_WORDS[0]}" == "npm" ]]; then
    platform="npm"
    if [[ "${COMP_WORDS[1]}" == "run" && "${COMP_WORDS[2]}" == "mgnl" ]]; then
      mode="local"
      offset=$LOCAL_OFFSET
      flag_start_index=LOCAL_FLAG_START
    else
      return 1
    fi
  elif [[ "${COMP_WORDS[0]}" == "yarn" ]]; then
    platform="yarn"
    if [[ "${COMP_WORDS[1]}" == "run" && "${COMP_WORDS[2]}" == "mgnl" ]]; then
      mode="local"
      offset=$LOCAL_OFFSET
      flag_start_index=LOCAL_FLAG_START
    elif [[ "${COMP_WORDS[1]}" == "mgnl" ]]; then
      mode="global"
      offset=1
      flag_start_index=$((GLOBAL_FLAG_START+1))
    else
      return 1
    fi
  elif [[ "${COMP_WORDS[0]}" == "mgnl" ]]; then
    platform="cli"
    mode="global"
    offset=$GLOBAL_OFFSET
    flag_start_index=$GLOBAL_FLAG_START
  else
    return 1
  fi

  # Calculate the current position relative to the actual mgnl arguments.
  local pos=$((COMP_CWORD - offset))

  ################## Helper Functions ##################
  _find_mgnl_config() {
    local dir="${PWD}"
    while [[ "$dir" != "/" && -n "$dir" ]]; do
      if [[ -f "$dir/$1" && -f "$dir/$2" ]]; then
        echo "$dir"
        return 0
      fi
      dir="${dir%/*}"
      [[ -z "$dir" ]] && dir="/"
    done
    return 1
  }

  _get_mod_time() {
    local file="$1"
    if [[ -f "$file" ]]; then
      if stat -c %Y "$file" >/dev/null 2>&1; then
        stat -c %Y "$file"
      else
        stat -f %m "$file"
      fi
    else
      echo 0
    fi
  }

  _generate_cache_filename() {
    local config_path="$1"
    local cache_hash
    if command -v md5sum >/dev/null 2>&1; then
      cache_hash=$(echo -n "$config_path" | md5sum | cut -d ' ' -f1)
    else
      cache_hash=$(echo -n "$config_path" | md5)
    fi
    local cache_dir="${TMPDIR:-/tmp}/mgnl-v5"
    mkdir -p "$cache_dir"
    echo "${cache_dir}/tab_completion_cache_${cache_hash}"
  }

  _find_and_load_mgnl_config() {
    local config_file_suffix config_file cache_file config_mod_time pj_mod_time cache_mod_time notInProject

    config_file_suffix="mgnl.config.js"
    config_file=$(_find_mgnl_config "$config_file_suffix" "package.json")
    if [[ -z "$config_file" ]]; then
      config_file_suffix="node_modules/@magnolia/cli/mgnl.config.js"
      config_file=$(_find_mgnl_config "$config_file_suffix" "package.json")
      if [[ -z "$config_file" && "${COMP_WORDS[0]}" == "mgnl" ]]; then
         local mgnl_bin resolved cli_dir cli_base default_config
         mgnl_bin=$(which mgnl 2>/dev/null)
         if [[ -n "$mgnl_bin" ]]; then
             resolved=$(readlink "$mgnl_bin")
             if [[ -n "$resolved" ]]; then
                 if [[ "$resolved" != /* ]]; then
                     resolved="$(dirname "$mgnl_bin")/$resolved"
                 fi
                 cli_dir=$(dirname "$resolved")
                 cli_base=$(dirname "$cli_dir")
                 default_config="$cli_base/dist/mgnl.config.js"
                 if [[ -f "$default_config" ]]; then
                     notInProject=1
                     config_file="$cli_base/dist"
                     config_file_suffix="mgnl.config.js"
                 else
                     return 1
                 fi
             else
                 return 1
             fi
         else
             return 1
         fi
      elif [[ -z "$config_file" ]]; then
         return 1
      fi
    fi

    local full_config_path="$config_file/$config_file_suffix"
    cache_file=$(_generate_cache_filename "$full_config_path")
    config_mod_time=$(_get_mod_time "$full_config_path")
    pj_mod_time=$(_get_mod_time "$config_file/package.json")
    cache_mod_time=$(_get_mod_time "$cache_file")
    if [[ "$cache_mod_time" -ge "$config_mod_time" && "$cache_mod_time" -ge "$pj_mod_time" ]]; then
      script_output=$(cat "$cache_file")
    else
      script_output=$(_run_node_script "$full_config_path")
      echo "$script_output" > "$cache_file"
    fi
    if [[ "$script_output" == *"<optout/>"* ]]; then
      commands=$script_output
    else
      commands=$(_extract_commands "$script_output")
      if [[ "${notInProject}" -eq 1 ]]; then
        commands=$(echo "$commands" | tr ' ' '\n' | grep -vE '^(add-plugin)$' | tr '\n' ' ' | xargs)
      fi
    fi
  }

  _handle_flags_completion() {
    local opts=("$@")
    local used_opts=()
    if [[ $pos -gt 2 ]]; then
      for opt_entry in "${opts[@]}"; do
        IFS='|' read -r long_opt short_opt requires_param <<< "$opt_entry"
        if [[ "${prev}" == "${long_opt}" || "${prev}" == "${short_opt}" ]]; then
          local cwdMatches
          cwdMatches=$(compgen -f -- "${cur}")
          if [[ ( "${requires_param}" -eq 1 && "${cur}" == "" ) || "${cur}" == "."* || "${cur}" == "/"* || ( -n "${cur}" && -n "${cwdMatches}" ) ]]; then
            if [[ -z "${cur}" ]]; then
              COMPREPLY=( $(compgen -f -- "./") )
              COMPREPLY=( "${COMPREPLY[@]/#/./}" )
            else
              COMPREPLY=( $(compgen -f -- "${cur}") )
            fi
            return 0
          fi
        fi
      done
    fi
    for word in "${COMP_WORDS[@]:$flag_start_index}"; do
      for opt_entry in "${opts[@]}"; do
        IFS='|' read -r long_opt short_opt _ <<< "$opt_entry"
        if [[ "${word}" == "${long_opt}" || "${word}" == "${short_opt}" ]]; then
          used_opts+=("${long_opt}")
        fi
      done
    done
    local unused_opts=()
    for opt_entry in "${opts[@]}"; do
      IFS='|' read -r long_opt short_opt _ <<< "$opt_entry"
      if [[ ! " ${used_opts[*]} " =~ " ${long_opt} " && ! " ${used_opts[*]} " =~ " ${short_opt} " ]]; then
        unused_opts+=("${long_opt}" "${short_opt}")
      fi
    done
    COMPREPLY=( $(compgen -W "${unused_opts[*]}" -- "${cur}") )
  }

  _load_flags_of_curcommand() {
    local command="$1"
    local flags
    if [[ $command == "add-plugin" ]]; then
      if [[ $((COMP_CWORD - offset)) -eq $((flag_start_index - 1)) ]]; then
        flags=""
      else
        flags=$(npm search @magnolia/cli- --json | \
          grep -o '"name": *"@magnolia/cli-[^"]*-plugin"' | \
          sed -e 's/"name": *"//' -e 's/"$//' | \
          grep -vxFf <(jq -r '.dependencies | keys[]' package.json | grep '^@magnolia/cli-.*-plugin') | \
          sed -e 's/^/ |/' -e 's/$/|0/')
      fi
    else
      flags=$(echo "$script_output" | awk "/<$command>/,/<\/$command>/ { if (/<option>/) { gsub(/.*<option>|<\/option>.*/,\"\"); print } }")
    fi
    [[ -z "$flags" ]] && return 0
    local opts=()
    while IFS= read -r opt; do
      opts+=("$opt")
    done <<< "$flags"
    _handle_flags_completion "${opts[@]}"
  }

  _extract_commands() {
    echo "$1" | awk '/<plugins>/,/<\/plugins>/ {
      if (/<plugin>/) { gsub(/.*<plugin>|<\/plugin>.*/, ""); print }
    }' | tr '\n' ' ' | sed 's/[[:space:]]*$//'
  }

  _extract_plugins_with_param() {
    echo "$1" | awk '/<pluginsWithParam>/,/<\/pluginsWithParam>/ {
      if (/<plugin>/) { gsub(/.*<plugin>|<\/plugin>.*/, ""); print }
    }' | tr '\n' ' ' | sed 's/[[:space:]]*$//'
  }

  _run_node_script() {
    node --input-type=module -e "
      import config from 'file://$1';
      if (config) {
        const result = [];
        const pluginsWithParam = [];
        const options = [];
        if (config.tabCompletion === false) {
          console.log('<optout/>')
        }
        if (config.tabCompletion && config.plugins) {
          const plugins = config.plugins;
          for (let i = 0; i < plugins.length; i++) {
            const plugin = plugins[i];
            result.push(\`<plugin>\${plugin.name}</plugin>\n\`);
            if (plugin.usage && plugin.usage[0] === '<') {
              pluginsWithParam.push(\`<plugin>\${plugin.name}</plugin>\n\`);
            }
            if (plugin.options?.length) {
              options.push(\`<\${plugin.name}>\n\`);
              for (let j = 0; j < plugin.options.length; j++) {
                const option = plugin.options[j];
                options.push(\`<option>\${option.long}|\${option.short}|\${option.flags.includes('<') ? '1' : '0'}</option>\n\`);
              }
              options.push(\`</\${plugin.name}>\n\`);
            }
          }
          options.push(\`<tab-completion>\n\`);
          options.push(\`<option>--enable|-e|0</option>\n\`);
          options.push(\`<option>--disable|-d|0</option>\n\`);
          options.push(\`<option>--uninstall|-u|0</option>\n\`);
          options.push(\`<option>--reinstall|-r|0</option>\n\`);
          options.push(\`</tab-completion>\n\`);
          options.push(\`<watch-mode>\n\`);
          options.push(\`<option>--use-config|-uc|0</option>\n\`);
          options.push(\`</watch-mode>\n\`);
          console.log(\`<config>\n<plugins>\n\${result.join('')}<plugin>help</plugin>\n<plugin>add-plugin</plugin>\n<plugin>watch-mode</plugin>\n<plugin>tab-completion</plugin>\n</plugins>\n<pluginsWithParam>\n\${pluginsWithParam.join('')}</pluginsWithParam>\n<options>\n\${options.join('')}</options>\n</config>\`);
        }
      } else {
        process.exit(1);
      }
    "
  }

  ################## Main Logic ##################
  _find_and_load_mgnl_config
  [[ -z "${commands}" || "$commands" == *"<optout/>"* ]] && return 1

  if [[ $pos -eq 1 ]]; then
    if [[ "$platform" == "yarn" ]]; then
      COMPREPLY=( $(compgen -W "${commands}" -- "${cur}") )
    elif [[ "$mode" == "local" ]]; then
      COMPREPLY=( $(compgen -W "${commands} --" -- "${cur}") )
    else
      COMPREPLY=( $(compgen -W "${commands}" -- "${cur}") )
    fi
  elif [[ $pos -gt 1 ]]; then
    local commands_with_param=$(_extract_plugins_with_param "${script_output}")
    if [[ "$platform" == "yarn" ]]; then
      local curcommand="${COMP_WORDS[$((offset+1))]}"
      if [[ " ${commands_with_param} " =~ " ${curcommand} " && $pos -eq 2 ]]; then
        COMPREPLY=( $(compgen -W "name" -- "${cur}") )
        return 0
      fi
      _load_flags_of_curcommand "${curcommand}"
    elif [[ "$mode" == "local" ]]; then
      local first_arg="${COMP_WORDS[$((offset+1))]}"
      local second_arg="${COMP_WORDS[$((offset+2))]}"
      local third_arg="${COMP_WORDS[$((offset+3))]}"
      if [[ ( "${first_arg}" == "--" && " ${commands} " =~ " ${second_arg} " ) || \
            ( "${second_arg}" == "--" && " ${commands} " =~ " ${first_arg} " ) || \
            ( "${third_arg}" == "--" && " ${commands_with_param} " =~ " ${first_arg} " ) ]]; then
        local curcommand=""
        if [[ " ${commands} " =~ " ${first_arg} " ]]; then
          curcommand="${first_arg}"
        elif [[ " ${commands} " =~ " ${second_arg} " ]]; then
          curcommand="${second_arg}"
        fi
        if [[ " ${commands_with_param} " =~ " ${curcommand} " && $pos -eq 3 ]]; then
          COMPREPLY=( $(compgen -W "name" -- "${cur}") )
          return 0
        fi
        _load_flags_of_curcommand "${curcommand}"
      elif [[ "${first_arg}" == "--" ]]; then
        COMPREPLY=( $(compgen -W "${commands}" -- "${cur}") )
      elif [[ " ${commands} " =~ " ${first_arg} " ]]; then
        COMPREPLY=( $(compgen -W "--" -- "${cur}") )
      fi
    else
      local curcommand="${COMP_WORDS[$((offset+1))]}"
      if [[ " ${commands_with_param} " =~ " ${curcommand} " ]]; then
        if [[ $pos -eq 2 ]]; then
          COMPREPLY=( $(compgen -W "name" -- "${cur}") )
          return 0
        else
          _load_flags_of_curcommand "${curcommand}"
        fi
      else
        _load_flags_of_curcommand "${curcommand}"
      fi
    fi
  fi

  return 0
}

# Register the completion function for both npm-run and global usage.
{{#if local}}
complete -F _mgnl_tab_completion npm
complete -F _mgnl_tab_completion yarn
{{/if}}
{{#if global}}
complete -F _mgnl_tab_completion mgnl
{{/if}}
