import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';
import { getMgnlConfigPath } from '@magnolia/cli-helper/config';
const __dirname = path.dirname(fileURLToPath(import.meta.url));
import { execSync } from 'child_process';
import { createRequire } from 'module';

const require = createRequire(import.meta.url);

const plugins = [
	'@magnolia/cli-jumpstart-plugin',
	'@magnolia/cli-generate-plugin',
];

const updateOutdatedPlugins = async () => {
	for (const plugin of plugins) {
		await updatePluginIfOutdated(plugin);
	}
};

async function updatePluginIfOutdated(plugin) {
	try {
		// Get the latest version of the plugin from the npm registry
		const latestVersionOutput = execSync(`npm view ${plugin} version`)
			.toString()
			.trim();

		if (!latestVersionOutput) {
			// eslint-disable-next-line no-console
			console.warn(
				`Cannot get latest version for ${plugin}: npm view returned empty result`,
			);
			return;
		}

		const latestVersion = latestVersionOutput;

		// Resolve the path to the plugin's package.json relative to this script's location
		const pluginPackagePath = require.resolve(`${plugin}/package.json`, {
			paths: [__dirname],
		});

		// Go up two levels to the mgnl root
		const mgnlRoot = path.resolve(pluginPackagePath, '../..');

		// Get the current version from the locally cached package
		const packageData = require(pluginPackagePath);

		if (!packageData || typeof packageData.version !== 'string') {
			// eslint-disable-next-line no-console
			console.warn(
				`Cannot read version from ${plugin}: package.json missing or invalid version property`,
			);
			return;
		}

		const currentVersion = packageData.version;

		if (currentVersion !== latestVersion) {
			// eslint-disable-next-line no-console
			console.log(`Updating: ${plugin} to the latest version`);
			execSync(`npm install ${plugin}@latest --no-audit --no-fund`, {
				cwd: mgnlRoot,
				stdio: 'inherit',
			});
			// Add a blank line for better readability
			// eslint-disable-next-line no-console
			console.log('\n');
		}
	} catch (e) {
		// Handle case where error object might be undefined or not have message property
		const errorMessage =
			e && typeof e.message === 'string'
				? e.message
				: typeof e === 'string'
					? e
					: 'Unknown error occurred';

		// eslint-disable-next-line no-console
		console.warn(`Cannot update ${plugin}: ${errorMessage}`);
	}
}

const update = async () => {
	if (!fs.existsSync(getMgnlConfigPath())) {
		await updateOutdatedPlugins();
	}
};

export default update;
