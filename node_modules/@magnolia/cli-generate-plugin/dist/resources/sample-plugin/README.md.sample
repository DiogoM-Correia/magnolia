# {{pluginName}} - A Magnolia CLI plugin
This is a plugin generated by the Magnolia CLI Plugin Generator, acting as a starting point for developers to build
their own plugins. The sample plugin showcases basic functionality, which you're encouraged to modify to fit your needs.

## package.json
A `package.json` file is prepared for you. The "name" property is currently set to: {{pluginName}}.
Feel free to change it later to better match your project's requirements.
Don't forget to update the "description" in the `package.json` file as well,
to make sure it accurately reflects the functionality and purpose of your plugin.
You'll find several dependencies included. These are intended to simplify the development process of your plugin.

## {{pluginName}}.ts description
The sample plugin helps you understand how to create a new plugin. Most of the changes you'll make in:
{{pluginName}}.ts file. We advise implementing your plugin in TypeScript to benefit from type safety and easily extend
the `PluginTemplate`, which dictates necessary attributes and functions.

> Note: To execute the examples in the following section, you must first install the plugin in your project: [Integration with Magnolia CLI](#integration-with-magnolia-cli)

#### Attributes and Functions
- **name attribute**: Determines the command to start the plugin.

  By default, it's set to `pkg.name` from package.json:
  ```javascript
  export default class {{className}} extends PluginTemplate {
      ...
      name = pkg.name; // Will be "{{pluginName}}" in your case
      ...
  }
  ```
  The command you will use to start the plugin **in your project**: `npm run mgnl -- {{pluginName}} --name John`

  You can assign your own name:
  ```javascript
  export default class {{className}} extends PluginTemplate {
      ...
      name = "greet";
      ...
  }
  ```
  Then, the command you will use to start the plugin **in your project** will be: `npm run mgnl -- greet --name John`

  > Note: In following sections '{{pluginName}}' is assumed to be the name attribute of the plugin

- **description attribute**: Provides an information about the plugin when the `--help` or `-h` option is used.

  By default, the description value is obtained form package.json:
  ```javascript
  export default class {{className}} extends PluginTemplate {
      ...
      description = pkg.description; // Will be "{{pluginName}} description" in your case
      ...
  }
  ```

  When you use help option (--help or -h) of Magnolia CLI:
  ```bash
  npm run mgnl -- -h
  ```
  You'll get:
  ```
  Welcome to Magnolia Accelerator!
  Usage: @magnolia/cli [options] [command]

  CLI for Magnolia projects

  Options:
    -V, --cli-version          output the version number
    -h, --help                 display help for command

  Commands:
    {{pluginName}} [options]   {{pluginName}} description
    help [command]             display help for command
  ```
  > Note the: "{{pluginName}} [options] {{pluginName}} description" text

  When you use help option (--help or -h) of the plugin:
  ```bash
  npm run mgnl {{pluginName}} -- -h
  ```
  You'll get:
  ```
  Welcome to Magnolia Accelerator!
  Usage: @magnolia/cli {{pluginName}} [options]

  {{pluginName}} description

  Options:
    -v, --plugin-version  output the version number
    -n, --name <name>     Say hello to <name>
    -h, --help            display help for command
  ```
  > Note the: "{{pluginName}} description" text

  You can customize the value in the `package.json` or directly in the code:
  ```javascript
  export default class {{className}} extends PluginTemplate {
      ...
      description = "This plugin greets the user by name."
      ...
  }
  ```

  When you use help option (--help or -h) of Magnolia CLI:
  ```bash
  npm run mgnl -- -h
  ```
  You'll get:
  ```
  Welcome to Magnolia Accelerator!
  Usage: @magnolia/cli [options] [command]

  CLI for Magnolia projects

  Options:
    -V, --cli-version          output the version number
    -h, --help                 display help for command

  Commands:
    {{pluginName}} [options]  This plugin greets the user by name.
    help [command]             display help for command
  ```
  > Note the: "This plugin greets the user by name." text

  When you use help option (--help or -h) of the plugin:
  ```bash
  npm run mgnl {{pluginName}} -- -h
  ```
  You'll get:
  ```
  Welcome to Magnolia Accelerator!
  Usage: @magnolia/cli {{pluginName}} [options]

  This plugin greets the user by name.

  Options:
    -v, --plugin-version  output the version number
    -n, --name <name>     Say hello to <name>
    -h, --help            display help for command
  ```
  > Note the: "This plugin greets the user by name." text

- **logger attribute**:

  The sample code includes a logger attribute:
  ```javascript
  export let logger: Logger;
  ```
  This logger is initialized by the Magnolia CLI during the _init_ function. It offers a consistent method for
  displaying various types of messages, such as info, warnings, and errors, both in the console and in a log file.
  Configuration of the logger is set automatically by Magnolia CLI, but you can adjust it in the mgnl.config.js file.

  The logger is exported in the sample to allow usage of it across different modules or files within the plugin, you can
  also retain it as a class attribute if that better fits your structure.

  For easier troubleshooting, it's advisable to make use of the logger attribute. This way, if issues arise, users can
  provide you with a detailed log file to assist in debugging.

- **options attribute** and **PluginOptions interface**:

  When developing a plugin, you often want to provide customization options to the end-users. In the context of our
  sample code, this is achieved through the `options` attribute. This attribute is an array that defines the possible
  command-line options that user can use when invoking your plugin.

  The [commander package](https://www.npmjs.com/package/commander) is utilized to achieve this. Within our plugin,
  the `Option` class from commander is used to describe each command-line option. To understand the various configuration
  possibilities with the Option type, you visit the
  [commander documentation](https://github.com/tj/commander.js#more-configuration).

  Every time you add a new option to the options attribute, you should also add a corresponding entry in the
  `PluginOptions` interface. This ensures that TypeScript recognizes and type-checks the options when you use them later
  in your code.

- **_init_ function**: Utilized by Magnolia CLI for instantiation purposes.

- **_stop_ function**:

  The stop function is called from Magnolia CLI when a SIGINT signal (e.g., ctrl+c) detected, the stop function should then
  gracefully disconnect any started processes, handle any things that need to happen before the plugin is stopped.
  It is the responsibility of the developer to handle it correctly.

- **_start_ function**:

  The start function is the function that gets called when a command is executed, e.g.:
  ```bash
  npm run mgnl {{pluginName}} -- --name John
  ```
  the provided options are passed in the `options` function parameter. Only options defined in class `options` attribute
  and in `PluginOptions` interface will be presented. Based on these options you can modify the plugin behavior.

  In the provided example:
  ```javascript
  export default class {{className}} extends PluginTemplate {
    ...
    async start(options: PluginOptions) {
      logger?.info("Plugin started");
      logger?.info('options', options);

      if (options.name) {
        this.sayHello(options.name)
      } else {
        logger?.warn("No --name <name> passed in options");
      }
    }
    ...
  }
  ```
  The user is presented with "Plugin started" message, following with a message containing provided options. The
  plugin checks if the name option is provided, if yes the sayHello function is called, if not a warning message is
  presented.

## Build
To build the project run:
```bash
npm run build
```

The project gets build into the 'dist' folder. Modify the "build" script in package.json is you need to copy other
files to the 'dist' folder, e.g. a 'resources' folder.

## Testing
A sample test file is provided to test the default code. Adjust or remove the tests to match your functionality.

To test the project run:
```bash
npm run test
```

## Integration with Magnolia CLI
This plugin is intended to work with Magnolia CLI.

For integrating with the Magnolia CLI:
1. Create a new project or use an existing one. To initiate a new project:
   ```bash
   npx @magnolia/cli jumpstart
   ```
2. Choose a suitable project template for testing.

### Add the plugin to your project
#### Pack the plugin
1. **In the plugin** folder, build the plugin:
   ```bash
   npm run build
   ```
2. **In the plugin** folder run:
   ```bash
   npm pack
   ```
   This will generate a `<pluginName>-<pluginVersion>.tgz` file, in our case: {{pluginName}}-1.0.0.tgz

#### Install the plugin
Using 'add-plugin':
3. **In the project** folder install the {{pluginName}}-1.0.0.tgz file using 'add-plugin':
     ```bash
     npm run mgnl -- add-plugin /path/to/{{pluginName}}-1.0.0.tgz
     ```
     The command will automatically install and register the plugin in mgnl.config.js

Manually:
3. **In the project** folder install the {{pluginName}}-1.0.0.tgz file using 'npm':
    ```bash
    npm i /path/to/{{pluginName}}-1.0.0.tgz
    ```
    You should have {{pluginName}} in package.json as a dependency:
    ```json
    {
      ...
      "dependencies": {
        "{{pluginName}}": "file:/path/to/{{pluginName}}-1.0.0.tgz"
      }
      ...
    }
    ```
4. In the project folder find mgnl.config.js file and add the plugin to the plugins' property:
   ```javascript
   import <className> from "<pluginName>";

   export default {
     ...
     // Add the <className> to the array
     plugins: [
       ...
       new <className>()
     ]
     ...
   };
   ```
   In our case:
   ```javascript
   import {{className}} from "{{pluginName}}";

   export default {
     ...
     // Add the {{className}} to the array
     plugins: [
       ...
       new {{className}}()
     ]
     ...
   };
   ```

### Run the plugin
```bash
npm run mgnl -- <pluginName>
```

In our case:
```bash
npm run mgnl -- {{pluginName}}
```

## Tips
1. Determining the current working directory:

   When developing locally, be aware of the distinction between `process.cwd()` and `process.env.INIT_CWD`:
   - Local Development: (`npm run mgnl <pluginName>`):
     - **`process.cwd()`**: Returns the directory of the package.json file.
     - **The issue**: If the command is executed in a child folder, this could lead to inaccuracies.
     - **`process.env.INIT_CWD`**: Provides the correct directory in which the npm script was initiated.
   - Global Installation of @magnolia/cli: (`mgnl <pluginName>`)
     - Thought it is not recommended it is possible to install '@magnolia/cli' globally.
     - Executing the plugin with `mgnl <pluginName>` allows `process.cwd()` to give the correct folder.
     - No `process.env.INIT_CWD` is provided

   To ensure consistent behavior in both cases, use the following:
   ```javascript
   const cwd = process.env.INIT_CWD || process.cwd();
   ```

   Reference: [npmjs documentation](https://docs.npmjs.com/cli/v9/commands/npm-run-script).

2. Passing parameters to the Magnolia CLI:

   When using the local Magnolia script (`npm run mgnl`), you need to append `--` before any parameters:
   - Example without Plugin:
     ```bash
     npm run mgnl -- --help
     ```
   - Example with Plugin:
     ```bash
     npm run mgnl -- <pluginName> --<optionName> <optionValue>
     ```

3. Suppressing npm's default output:

   By default, npm outputs some additional information. To suppress the additional information use `--silent` or `-s`:
   - Example without the --silent option:
     ```bash
     npm run mgnl -- --help
     ```
     Output:
     ```
     <folderName>@1.0.0 mgnl
     node node_modules/@magnolia/cli --help
     ...
     ```
   - Using the `--silent` or `-s` option:
     ```bash
     npm run mgnl -s -- --help
     ```
     won't show the additional output.

4. Path considerations across operating systems:

   Remember, Windows and Unix-based systems handle paths differently. Always use the `path` package to ensure paths are
   normalized and compatible across different OS environments.

## Conclusion
This README aims to support you in creating your own plugin. Feel free to remove the sample code and tailor it to your
needs.
