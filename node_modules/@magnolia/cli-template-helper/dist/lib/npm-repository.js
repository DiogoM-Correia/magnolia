import { execaSync } from 'execa';
import { helper } from './helper.js';
function fetchAvailablePrototypesPackages() {
    const regex = new RegExp('^@magnolia/cli-.*-prototypes$');
    const availableFrameworks = execaSync('npm', [
        'search',
        '@magnolia/cli-',
        '--searchopts="prototypes"',
        '--searchexclude="deprecated"',
        '--json',
    ], {
        buffer: true,
        cwd: helper.pluginCwd,
    });
    const parsedAvailableFrameworks = JSON.parse(availableFrameworks.stdout);
    const filteredPackages = parsedAvailableFrameworks.filter((pkg) => regex.test(pkg.name));
    return filteredPackages.map((it) => {
        const availableVersions = execaSync('npm', ['view', it.name, 'versions', '--json'], {
            buffer: true,
            cwd: helper.pluginCwd,
        });
        const parsedVersions = JSON.parse(availableVersions.stdout);
        return { name: it.name, versions: parsedVersions };
    });
}
function getRepositoryUrl(framework) {
    const npmPackageMatch = framework.match(/^(.+?)@([^@]+)$/);
    let npmRepositoryUrl = `/${framework}/latest`;
    if (npmPackageMatch !== null) {
        npmRepositoryUrl =
            `/${npmPackageMatch[1]}` +
                (npmPackageMatch[2] ? `/${npmPackageMatch[2]}` : '/latest');
    }
    return npmRepositoryUrl;
}
export const npmRepository = {
    fetchAvailablePrototypesPackages,
    getRepositoryUrl,
};
