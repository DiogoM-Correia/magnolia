var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import path from 'path';
import fs from 'fs-extra';
import { CreateError } from '../general-utils/general-utils.js';
import { i18nInstance } from '../i18n/i18n.js';
import { promptForPrototype } from '../prompt/prompt.js';
import { getRelativePathToMGNLConfig } from '../config/config.js';
export function getAvailablePrototypes(searchDir) {
    if (!fs.existsSync(searchDir)) {
        return;
    }
    const files = fs.readdirSync(searchDir);
    let directories = [];
    for (const file of files) {
        const filePath = path.join(searchDir, file);
        if (fs.existsSync(filePath)) {
            const stat = fs.statSync(filePath);
            if (stat.isDirectory()) {
                directories.push(file);
            }
        }
    }
    directories = directories.sort((a, b) => a === '_default' ? -1 : b === '_default' ? 1 : a.localeCompare(b));
    return directories;
}
export function findPrototypesPath(prototypeDir, defaultPrototypeDir) {
    // Check if prototypeDir is provided via command line options
    const prototypeDirOptIdx = process.argv.indexOf('-pd') >= 0
        ? process.argv.indexOf('-pd')
        : process.argv.indexOf('--prototypeDir');
    if (prototypeDirOptIdx >= 0 &&
        process.argv.length > prototypeDirOptIdx + 1) {
        return path.resolve(process.argv[prototypeDirOptIdx + 1]);
    }
    if (prototypeDir) {
        return path.resolve(prototypeDir);
    }
    return defaultPrototypeDir;
}
export const validateAndResolvePrototype = (options, args, cliPrototypesPath, logger) => __awaiter(void 0, void 0, void 0, function* () {
    const pluginUpdates = {};
    let prototypeDir;
    let prototypeDirMsg = 'info-using-default-prototype-dir';
    if (options.prototypeDir) {
        prototypeDir = path.resolve(process.env.INIT_CWD || process.cwd(), options.prototypeDir);
        pluginUpdates.prototypeDir = getRelativePathToMGNLConfig(prototypeDir);
        prototypeDirMsg = 'info-using-option-prototype-dir';
    }
    else if (args.prototypeDir) {
        prototypeDir = path.resolve(process.cwd(), args.prototypeDir);
        prototypeDirMsg = 'info-using-config-prototype-dir';
    }
    if (prototypeDir) {
        if (!fs.existsSync(prototypeDir)) {
            throw new CreateError(i18nInstance.t('error-invalid-prototypeDir', {
                path: prototypeDir,
            }));
        }
        logger === null || logger === void 0 ? void 0 : logger.info(i18nInstance.t(prototypeDirMsg, { path: prototypeDir }));
    }
    else {
        prototypeDir = cliPrototypesPath;
        logger === null || logger === void 0 ? void 0 : logger.info(i18nInstance.t(prototypeDirMsg));
    }
    const availablePrototypes = getAvailablePrototypes(prototypeDir);
    if (!availablePrototypes || availablePrototypes.length === 0) {
        throw new CreateError(i18nInstance.t('error-no-available-prototypes', {
            prototypeDir: prototypeDir,
        }));
    }
    let prototype;
    let prototypeMsg;
    if (options.prototype) {
        if (typeof options.prototype === 'boolean') {
            prototype = yield promptForPrototype(availablePrototypes);
        }
        else {
            prototype = options.prototype;
            prototypeMsg = 'info-using-option-prototype';
        }
        pluginUpdates.prototype = prototype;
    }
    else if (args.prototype) {
        prototype = args.prototype;
        prototypeMsg = 'info-using-config-prototype';
    }
    else {
        prototype = '_default';
        prototypeMsg = 'info-using-default-prototype';
    }
    if (!availablePrototypes.includes(prototype)) {
        logger === null || logger === void 0 ? void 0 : logger.warn(i18nInstance.t('warn-prototype-not-found', { prototype }));
        prototype = yield promptForPrototype(availablePrototypes);
        pluginUpdates.prototype = prototype;
    }
    else if (prototypeMsg) {
        logger === null || logger === void 0 ? void 0 : logger.info(i18nInstance.t(prototypeMsg, { prototype }));
    }
    return {
        prototype,
        prototypeDir,
        pluginUpdates,
    };
});
