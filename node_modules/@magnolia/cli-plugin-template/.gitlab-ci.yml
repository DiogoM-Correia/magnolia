image: node:lts

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

stages:
  - pack
  - deploy

cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
  policy: pull-push

before_script:
  - echo "Using Node.js version:"
  - node -v
  - echo "Using npm version:"
  - npm -v
  - npm ci

pack:
  stage: pack
  script:
    - npm run build
    - npm pack
  artifacts:
    paths:
      - "*.tgz"
    expire_in: 1 week

deploy:
  stage: deploy
  script:
    - |
      if ! echo "$USERS_ALLOWED_TO_PUBLISH" | grep -q "$GITLAB_USER_LOGIN"; then
        echo "You are not authorized to deploy. Aborting.";
        exit 1;
      fi
    - |
      DEPLOY_TAG=$(node -e "
      const pkg = require('./package.json');
      if (pkg.version.includes('preview')) {
        console.log('preview');
      } else {
        console.log('latest');
      }")
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
    - echo "@magnolia:registry=https://registry.npmjs.org/" >> .npmrc
    - echo $DEPLOY_TAG
    - npm publish --access public --tag $DEPLOY_TAG
  only:
    - main
  when: manual